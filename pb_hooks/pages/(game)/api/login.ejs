<script server>
  const { ROOM_ID } = resolve('constants')
  const user = (() => {
    if (auth) return auth
    const usersCollection = $app.findCollectionByNameOrId('users')
    const user = new Record(usersCollection)
    const password = $security.randomStringWithAlphabet(40, '123456789')
    user.setPassword(password)
    $app.save(user)
    return user
  })()
  const token = user.newAuthToken()

  const { getRoomState, sanitizeRoomState } = resolve('room')
  const roomState = getRoomState(ROOM_ID)
  sanitizeRoomState(roomState, user)

  return { token, user, roomState }
</script>
