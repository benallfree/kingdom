<script server>
  if (!auth) {
    throw new BadRequestError('Unauthorized')
  }

  const { idx } = params

  if (!idx) {
    throw new BadRequestError('Missing idx')
  }

  const { getCurrentRoomState, setCurrentRoomState } = resolve('room')

  let roomState = {}
  $app.runInTransaction((txApp) => {
    roomState = getCurrentRoomState(txApp)
    if (roomState.grid[idx]?.playerId) {
      throw new BadRequestError(`Cell ${idx} already has a player`)
    }
    roomState.grid[idx] = { ...roomState.grid[idx], playerId: auth.id }
    roomState.roundExpiry = Date.now() + 1000 * 60 * 5
    setCurrentRoomState(roomState, txApp)
  })

  echo({ roomState })
</script>
