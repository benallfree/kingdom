<script server>
  if (!auth) {
    throw new BadRequestError('Unauthorized')
  }

  const { idx } = params

  if (!idx) {
    throw new BadRequestError('Missing idx')
  }

  const { getCurrentGrid, setCurrentGrid } = resolve('grid')

  let grid = {}
  $app.runInTransaction((txApp) => {
    grid = getCurrentGrid(txApp)
    if (grid[idx]?.playerId) {
      throw new BadRequestError(`Cell ${idx} already has a player`)
    }
    grid[idx] = { ...grid[idx], playerId: auth.id }
    setCurrentGrid(grid, txApp)
  })

  echo({ grid })
</script>
