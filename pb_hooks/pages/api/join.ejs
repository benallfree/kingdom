<script server>
  if (!auth) {
    throw new BadRequestError('Unauthorized')
  }

  const { idx } = params

  if (!idx) {
    throw new BadRequestError('Missing idx')
  }

  const { getRoomState, setPublicRoomState } = resolve('room')

  let roomState = {}
  let error = null

  $app.runInTransaction((txApp) => {
    roomState = getRoomState(txApp)

    const publicState = roomState.publicState

    if (
      publicState.grid[idx]?.playerId &&
      publicState.grid[idx].playerId !== auth.id
    ) {
      error = `Cell is occupied`
      return
    }
    if (!publicState.players[auth.id]) {
      publicState.players[auth.id] = { coins: 10, health: 0 }
    }

    if (publicState.players[auth.id]?.coins <= 0) {
      error = `Not enough coins`
      return
    }
    publicState.players[auth.id].coins -= 1
    publicState.players[auth.id].health += 1

    if (!publicState.grid[idx]) {
      publicState.grid[idx] = { playerId: auth.id, health: 0 }
    }
    publicState.grid[idx].health += 1
    publicState.roundExpiry = Date.now() + 1000 * 60 * 5

    setPublicRoomState(publicState, txApp)

    const hasPrize = roomState.privateState.prizeIdx == idx
    roomState.publicState.grid[idx].hasPrize = hasPrize
  })

  return { roomState: roomState.publicState, error }
</script>
