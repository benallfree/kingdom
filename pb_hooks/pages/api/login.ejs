<script server>
  const user = (() => {
    if (auth) return auth
    const usersCollection = $app.findCollectionByNameOrId('users')
    const user = new Record(usersCollection)
    const password = $security.randomStringWithAlphabet(40, '123456789')
    user.setPassword(password)
    $app.save(user)
    return user
  })()
  const token = user.newAuthToken()
  const { publicState, privateState } = resolve('room').getRoomState()

  const cell = publicState.grid[privateState.prizeIdx]
  if (cell && cell.playerId === user.id) {
    cell.hasPrize = true
  }

  return { token, user, roomState: publicState }
</script>
